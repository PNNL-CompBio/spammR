---
title: "spammR lipidomic and proteomic integration"
author: "Sara Gosline"
package: spammR
date: "`r format(Sys.Date(), '%b %d, %Y')`"
output: 
    BiocStyle::html_document:
        toc: true
        number_sections: true
        toc_depth: 3
        toc_float:
            collapsed: true
description: |
  A basic walkthrough of how to use the spammR package to perform a 
  spatial omics analysis for lipidomic and proteomic data. 
  
vignette: |
  %\VignetteIndexEntry{spammR-lipids}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  

---

# About
The goal of this vignette is to showcase integration between two different
omes in the same spatial context. For this we use a dataset from sections of 
rat brain measured via mass spetrometry imaging (MSI) to identify 
lipidomic measurements alongside proteomics from regions of interest from 
[Vandergrift et al](https://pubs.acs.org/doi/10.1021/acs.analchem.4c04462). 

We show how `spammR` enables:
- download and loading of datasets
- visualization of features within each dataset
- identification of correlated regions in this dataset

First we load the required packages.

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(spammR)

##there are additional dependencies
if (!require('tidyverse')) {
  install.packages("tidyverse")
  library(tidyverse)
}

if (!require('readxl')) {
  install.packages('readxl')
  library(readxl)
}

if (!require('geojsonR')) {
  install.packages('geojsonR')
  library(geojsonR)
}

if (!require('tidygraph')) {
  install.packages('tidygraph')
  library(tidygraph)
}

if (!require('ggraph')) {
  install.packages('ggraph')
  library(ggraph)
}

if (!require('cowplot')) {
  install.packages('cowplot')
  library(cowplot)
}
```

# Load proteomics data
The proteomics data can be found on 
[zenodo](https://zenodo.org/records/13345212) and downloaded directly. From 
there. 

## Format data
We require formatting the data as a matrix for loading. 

```{r get proteomics data, warning=FALSE, message=FALSE}

#brain data
finame <- paste0('https://zenodo.org/records/13345212/files/DESI+spatial',
                 '%20proteomics%20rat%20brain%20proteomics%20',
                 'result.xlsx?download=1')
fi <- download.file(finame,
                    dest = 'dat.xlsx')

#read in data, convert to matrix 
dat <- readxl::read_xlsx('dat.xlsx') 

feature_data <- select(dat, c(Protein,`Protein ID`,`Entry Name`,Gene)) |>
  dplyr::distinct() |>
  tibble::column_to_rownames('Protein')

dat <- select(dat, c(Protein, starts_with('ROI'))) |>
  tibble::column_to_rownames('Protein')

```

The image itself we downloaded separately from metaspace (see below) and
stored it in the package. 

```{r load image, warning=FALSE, message=FALSE}
##read in image
img <- system.file("extdata","brain_img_0.png",package = 'spammR')

```

Now that the image is loaded we can visualize it (not done here
to save space) to verify it is what we expect. 

```{r plot image, eval=FALSE}

cowplot::ggdraw() + cowplot::draw_image(system.file("extdata",
                                                    "brain_img_0.png",
                                                    package = "spammR"))
```

As you can see, there are squares chopped out of the image. These were the 
samples that were measured via proteomics. The next step is to map these
coordinates so we can compare them with the MSI data.

## Loading image coordinates rom GEOJson

We used the program [QuPath][(https://qupath.readthedocs.io/en/stable/) to 
collect the regions of interest (ROI) coordinates on the image. 
This program allowed us to highlight the regions of interest and export
them in GEOJson format, which can then be used as input into spammR. 

We store the GEOJson file in the package for you to load with this example.

```{r format coordinates, warning=FALSE, message=FALSE}
#remove this once we can include it in spammR
 
  library(geojsonR)
  jsondat <- FROM_GeoJson(system.file('extdata','brain_roi.geojson',
                                      package = 'spammR'))
 
  ##herr er hry yhr
  coords <- do.call(rbind, lapply(jsondat$features,function(x){
     roi <- x$properties$name
     xv <- x$geometry$coordinates[,1]
     yv <- x$geometry$coordinates[,2]
     if (is.null(roi))
        roi = ""
     return(list(ID = roi, x_pixels = min(xv), y_pixels = min(yv),
                  spot_height = max(yv) - min(yv),
                 spot_width = max(xv) - min(xv)))
     })) |>
     as.data.frame() |>
     subset(ID != "") |>
     tidyr::separate(ID,into = c('ROI','Replicate'), 
                     sep = '_', 
                     remove = FALSE) |>
     tibble::remove_rownames() |>
     tibble::column_to_rownames('ID')
 
 ##now for each ROI we want an x, y, cell height and cell_width
 #y-coordinates are from top, so need to udpate
  coords$y_pixels = 263 - unlist(coords$y_pixels) - unlist(coords$spot_height)
 
```

Now that we have the coordates we can use spammR to create the 
`SpatialExperiment` object and plot a protein.

## Create SpatialExperiment Object

Here we load the proteomics and create the object. 

```{r create proteomics spe, warning=FALSE, message=FALSE}  
   #create an SFE
  spe <- spammR::convert_to_spe(dat = dat, 
                      feature_meta = feature_data,
                      sample_meta = coords,
                      spatial_coords_colnames = c('x_pixels','y_pixels'),
                      assay_name = 'proteomics',
                      sample_id = 'rat_brain', 
                      image_files = img,
                      image_id = 'rat_brain')

  # myelin
  spammR::spatial_heatmap(spe, feature = 'Mbp', 
                          feature_type = 'Gene',
                sample_id = 'rat_brain', 
                image_id = 'rat_brain')

```

# Protein correlation across space

First we can look at protein activity across space.

## Functional enrichment of correlated proteins

We can also use `leapR` to calculate correlation across space and the biological
pathways of interest. To avoid having to build a rat database, we mapped the 
rat gene names to human to use the existing libraries in leapR 
(which are human).

```{r correlation enrichment, warning=FALSE, message=FALSE}

library(leapR)
data(krbpaths)

#first we create human gene names from rat
rowData(spe) <- rowData(spe) |> 
  as.data.frame() |>
  dplyr::mutate(upperGene = toupper(Gene))

#then calculate correlation enrichment
res <- leapR::leapR(krbpaths, 'correlation_enrichment',id_column = 'upperGene',
                    spe,'proteomics')

res[,c('ingroup_n','ingroup_mean','pvalue','BH_pvalue')] |> 
  dplyr::arrange(BH_pvalue) |>
  head()

```

We see that oxidative phosphorylation, is one of the more significantly 
correlated pathways across the regions of interest. 

## Plotting of pathway proteins

We can extract the proteins and plot them visually.

```{r heatmaps, warning=FALSE, message=FALSE}

oxphos <- unlist(strsplit(res$ingroupnames[1],','))

#lets visualize only the oxphos proteins in the brain
spatial_heatmap(spe,feature = oxphos, assay_name = 'proteomics',
                sample_id = 'rat_brain',  image_id = 'rat_brain',
                plot_log = TRUE)

```


Clearly the oxidative phosphorylation pathway is diverse across the brain. We
can look at which of these proteins are the most variable by just calculating 
variance.


```{r protein variance, warning=FALSE, message=FALSE}

var_val <- apply(assay(spe,'proteomics')[oxphos,], 1, var) |>
  sort()

vv <- data.frame(Gene = rowData(spe)[names(var_val),'Gene'],
                 var = var_val)

ggplot(vv,aes(x = reorder(Gene,var), y = var)) + 
  geom_bar(stat = 'identity') +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

```

## Protein-protein correlation across space

We can also look to see how proteins are correlated across space using
the`spatial_network` function. This function builds a graph that we can then 
plot using `ggraph`.

```{r correlation networks, warning=FALSE, message=FALSE}

#let's get gene names
gn <- rowData(spe)[oxphos,'Gene']

pg <- spatial_network(spe, features_of_interest = gn,
                      assay_names = 'proteomics',
                      feature_names = 'Gene')

##let's get a list of some interesting proteins??
pg |> activate(edges) |>
  filter(corval > 0.5) |>
  ggraph()  +
  geom_edge_link(aes(colour = corval)) + 
  geom_node_point() + 
  geom_node_label(aes(label = name))

```

Hk1, the gene with the highest variability, also seems to be correlated with 
two distinct subnetworks in the oxidative posphorylation pathway. 

Here we can visualize Hk1 and Eno1, which have slightly different correlation 
patterns. 

```{r hk1 plot}

spatial_heatmap(spe,feature = 'Hk1', feature_type = 'Gene',
                assay_name = 'proteomics',
                sample_id = 'rat_brain',  image_id = 'rat_brain',
                plot_log = TRUE)


spatial_heatmap(spe,feature = 'Eno1', feature_type = 'Gene',
                assay_name = 'proteomics',
                sample_id = 'rat_brain',  image_id = 'rat_brain',
                plot_log = TRUE)
```

# Load lipidomics data

Now that we have the image and protein data loaded, we can
begin to ingest the lipid data from metaspace. This 
requires an additional command to pull the information directly.

## Retrieve metaspace data
We created a wrapper to the [Metaspace python package]() to enable
download and formatting of metaspace measurements for spammR. 

The result is a `SpatialExperiment`

```{r metaspace import and plotting, warning=FALSE, message=FALSE}
##get lipid data from metaspace 
mspe <- spammR::retrieve_metaspace_data("2024-02-15_20h37m13s", 
                                fdr = 0.2, 
                                assay_name = 'lipids',
                                sample_id = 'rat_brain',
                                rotate = TRUE, 
                                drop_zeroes = TRUE)
## add in image to check 
mspe <- SpatialExperiment::addImg(mspe, img, scaleFactor = NA_real_,
                                  sample_id = 'rat_brain',
                                  image_id = 'rat_brain')

meta <- rowData(mspe) 
meta$Name <- vapply(meta$moleculeNames, function(x) {
 x[1]}, character(1))
rowData(mspe) <- meta

spatial_heatmap(mspe, feature = 'C41H78NO7P-H-',
                 assay = 'lipids',
                 plot_log = TRUE,
                   metric_display = 'Lipid expression',
                sample_id = 'rat_brain',
                image_id = 'rat_brain')#plot with an ion


```

Here we can see the overlay of specific lipids.

## Merging images to single coordinate system

Since the proteomics is measured in discrete ROI and the lipids are measured
on a per-pixel basis, to carry out pure multiomic comparisons we need to map
them to the same coordinate space.

To do this we use the `spat_reduce` function to reduce the lipidomics data
to the same regions as the proteomics. 

```{r reduce, echo=FALSE, warning=FALSE, message=FALSE}
reduced <- spat_reduce(spe_target = spe, 
                       spe_origin = mspe, 
                       origin_assay = 'lipids')

```

Now we can start to analyze the relationship between lipids and proteins.
# Correlation analysis

One of the innovative analyses we can do with the spatial data is to evaluate
correlations within molecules across space. 


## Protein-lipid correlation analysis 

Next we can ask what lipids are highly correlated with oxphos proteins as an
example of how we can use the spatial expression patterns to extract testable
biological hypotheses. This can take a while as it computes all correlations.

```{r lipid networks, warning= FALSE}

#first we create list of oxphos proteins and all lipids
fl <- c(gn, rowData(altExp(reduced))[,'Name'])

cg <- spatial_network(reduced, assay_names = c("proteomics","lipids"), 
                      features_of_interest = fl,
                      feature_names = c('Gene','Name'))

rg <- cg |> activate(edges) |>
  filter(corval > 0.5)

```

Given how large this graph is (many lipids are correlated with one another), we
can reduce to just look at correlation with Hk1, the protein named above.

### Protein neighborhood plotting

```{r hk1 neighborhood, warning=FALSE, message=FALSE}
#maybe get the neighborhood of Hk1,
gt <- rg %>%
  activate(nodes) |>
  as_tibble()

prot_neigh <-  rg |>
  to_local_neighborhood(node = which(gt$name == 'Hk1'), order = 1)

prot_neigh$neighborhood |> ggraph()  +
  geom_edge_link(aes(colour = corval)) + 
  geom_node_point(aes(color = class)) +
  geom_node_label(aes(label = name, color = class))

```

There are two lipids that show up as correlated with Hk1, but not with each 
other.

### Lipid expression plotting
Many lipids show up in our graph

```{r plot lipid, warning = FALSE, message = FALSE}

li <- prot_neigh$neighborhood |>
  activate(nodes) |>
  as_tibble() |>
  subset(class == 'lipids')

p1 <- spatial_heatmap(reduced, assay_name = 'lipids',
                feature = li$name[1],
                feature_type = 'Name',
                sample_id = 'rat_brain',
                image_id = 'rat_brain', 
                plot_log = TRUE, 
                plot_title = li$name[1],
                metric_display = 'Lipid expression')

p2 <- spatial_heatmap(mspe, assay_name = 'lipids',
                feature = li$name[1],
                feature_type = 'Name',
                sample_id = 'rat_brain',
                image_id = 'rat_brain', 
                plot_log = TRUE, 
                plot_title = li$name[1],
                metric_display = 'Lipid expression')

cowplot::plot_grid(p1,p2, nrow = 2)
```

You can see how the `spat_reduce` function averaged the expression across 
specific ROI, and also how expression of this Glycerophospholipid changes
in the brain.


# Summary
This vignette explores how one can use the spammR package to analyze multiomics
measurements captured in a spatial context.


